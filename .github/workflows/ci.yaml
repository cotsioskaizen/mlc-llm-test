name: CI Pipeline for MLC-LLM Repository

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:


env:
  RELEASE_NAME: "mlc-llm"
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}

jobs:
  build-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Login to Github Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_TOKEN }}
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Docker image with cache
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.IMAGE_NAME }}/${{ env.RELEASE_NAME }}:latest
          cache-from: type=registry,ref=${{ env.IMAGE_NAME }}/${{ env.RELEASE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.IMAGE_NAME }}/${{ env.RELEASE_NAME }}:buildcache,mode=max
  
  test:
    runs-on: ubuntu-latest
    needs: build-image
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Login to Github Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Pull Docker Image from GitHub Container Registry
        run: |
          docker pull $IMAGE_NAME/$RELEASE_NAME:latest

      - name: Run Tests inside Docker Container
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace/mlc-llm-test \
            $IMAGE_NAME/$RELEASE_NAME:latest bash -c "
                cd /workspace/mlc-llm-test &&
                bash ci/task/black.sh &&
                bash ci/task/isort.sh
          "

  build-linux-wheel:
    runs-on: ubuntu-latest
    needs: [build-image, test]
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Login to Github Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Pull Docker Image from GitHub Container Registry
        run: |
          docker pull $IMAGE_NAME/$RELEASE_NAME:latest

      - name: Build Release inside Docker Container
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace/mlc-llm-test \
            $IMAGE_NAME/$RELEASE_NAME:latest build

      - name: Upload Release Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.RELEASE_NAME }}-linux
          path: ${{ github.workspace }}/python/dist/*.whl

  build-windows-wheel:
    runs-on: windows-latest
    needs: [build-image, test]
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Install build tools
        shell: pwsh
        run: |
          choco install cmake --version 3.24 --installargs 'ADD_CMAKE_TO_PATH=System' -y
          choco install ninja -y
          choco install git-lfs -y
          git lfs install

      - name: Run build script
        shell: pwsh
        run: |
          ./build-wheel-windows.ps1 -PythonVersion "3.13" -BuildType "Release"

      - name: Upload Release Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.RELEASE_NAME }}-windows
          path: ${{ github.workspace }}/python/dist/*.whl
  
  release:
    runs-on: ubuntu-latest
    needs: [build-linux-wheel, build-windows-wheel]
    permissions:
      contents: read
      packages: write

    steps:
      - name: Download Linux Artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.RELEASE_NAME }}-linux
          path: ./artifacts/linux
      
      - name: Download Windows Artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.RELEASE_NAME }}-windows
          path: ./artifacts/windows

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Linux Wheel
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./artifacts/linux/*.whl
          asset_name: mlc_llm-linux.whl
          asset_content_type: application/octet-stream

      - name: Upload Windows Wheel
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./artifacts/windows/*.whl
          asset_name: mlc_llm-windows.whl
          asset_content_type: application/octet-stream

